
# 6-20-2015
#
# Trying to run Caffe on EC2
# Would be shorter if we had used Anaconda
# did not get CUDA to work (could not apply driver)
#
# https://news.ycombinator.com/item?id=9749660
# http://rocknrollnerd.github.io/ml/2015/05/27/leopard-sofa.html
# http://nbviewer.ipython.org/github/BVLC/caffe/blob/master/examples/classification.ipynb
# http://caffe.berkeleyvision.org/installation.html


# Maybe try a g2.8xlarge instance (about $2.60 per hour)
# OS: Ubuntu Server 14.04 LTS (HVM), SSD Volume Type - ami-5189a661

# On your local machine, ssh to EC2 intance
# ssh -i KEY.PEM  ubuntu@IPADDRESS


# ON EC2 instance, install the stuff you need
# also copy the contents of this repository to your instance



##  # CUDA did not work
##  # From
##  #  http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using_cluster_computing.html#gpu-operating-systems
##  sudo apt-get -y update
##  sudo reboot
##  # from https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel
##  sudo apt-get -y install dpkg-dev
##  sudo apt-get -y source linux-image-$(uname -r)
##  sudo apt-get -y build-dep linux-image-$(uname -r)
##  cd linux-3.13.0
##  sudo chmod a+x debian/scripts/*
##  sudo chmod a+x debian/scripts/misc/*
##  sudo fakeroot debian/rules clean
##  sudo fakeroot debian/rules binary-headers binary-generic
##  sudo reboot
##  sudo apt-get -y update
##  #  For G2 instances I think the Nvidia URL is: http://us.download.nvidia.com/XFree86/Linux-x86_64/352.21/NVIDIA-Linux-x86_64-352.21.run
##  wget http://us.download.nvidia.com/XFree86/Linux-x86_64/352.21/NVIDIA-Linux-x86_64-352.21.run
##  sudo /bin/bash ./NVIDIA-Linux-x86_64-352.21.run 
##  
##  #  # From: http://askubuntu.com/questions/451672/installing-and-testing-cuda-in-ubuntu-14-04
##  #  sudo apt-get -y install build-essential
##  #  # From: https://developer.nvidia.com/cuda-downloads
##  #  wget http://developer.download.nvidia.com/compute/cuda/7_0/Prod/local_installers/cuda_7.0.28_linux.run
##  #  mkdir nvidia_installers
##  #  sudo bash ./cuda_7.0.28_linux.run -extract=~/nvidia_installers
##  #  sudo apt-get --purge remove nvidia-*
##  #  cd ~/nvidia_installers
##  #  sudo service lightdm stop
##  #  sudo killall Xorg
##  #  sudo ./NVIDIA-Linux-x86_64-346.46.run
##  


# From: http://caffe.berkeleyvision.org/install_apt.html
sudo apt-get -y  update
sudo apt-get -y  install libprotobuf-dev libleveldb-dev libsnappy-dev libopencv-dev libboost-all-dev libhdf5-serial-dev
sudo apt-get -y  install libatlas-base-dev
sudo apt-get -y install gfortran
sudo apt-get -y  install libgflags-dev libgoogle-glog-dev liblmdb-dev protobuf-compiler
sudo apt-get -y  install python-dev

# From: https://github.com/BVLC/caffe
sudo apt-get -y  install git
sudo apt-get -y  install emacs
git clone https://github.com/BVLC/caffe.git

# From: http://rocknrollnerd.github.io/ml/2015/05/27/leopard-sofa.html
# http://nbviewer.ipython.org/github/BVLC/caffe/blob/master/examples/classification.ipynb
sudo apt-get -y install python-pip
sudo pip install numpy matplotlib
sudo pip install "ipython[all]"


export PYTHONPATH=/home/ubuntu/caffe/python:$PYTHONPATH


# From http://stackoverflow.com/questions/2213551/installing-scipy-with-pip
sudo pip install cython
sudo pip install scipy
# From https://github.com/BVLC/caffe/issues/50
sudo pip install scikit-image

# From https://groups.google.com/forum/#!topic/caffe-users/9Q10WkpCGxs
sudo pip install protobuf





# From: https://github.com/BVLC/caffe/issues/1988
export LD_LIBRARY_PATH=/home/ubuntu/caffe/.build_release/lib/:$LD_LIBRARY_PATH

git clone https://github.com/JohnMount/CaffeECSExample.git


# From: http://caffe.berkeleyvision.org/installation.html#compilation
cd caffe
cp Makefile.config.example Makefile.config
patch Makefile.config ../CaffeECSExample/Makefile.patch
make all
# make test
# make runtest
make pycaffe


# Ingore 1394 warning
# http://stackoverflow.com/questions/12689304/ctypes-error-libdc1394-error-failed-to-initialize-libdc1394

# get model
scripts/download_model_binary.py models/bvlc_reference_caffenet

# to get codes:
pushd data/ilsvrc12
bash get_ilsvrc_aux.sh
# look at synset_words.txt
# fgrep -n crab synset_words.txt 
# 119:n01978287 Dungeness crab, Cancer magister
# 120:n01978455 rock crab, Cancer irroratus
# 121:n01980166 fiddler crab
# 122:n01981276 king crab, Alaska crab, Alaskan king crab, Alaska king crab, Paralithodes camtschatica
# 126:n01986214 hermit crab
popd

cd examples
cp ../../CaffeECSExample/qExample.py .
# run example 
python qExample.py


# get a Java on
sudo apt-get -y install default-jre
sudo apt-get -y install default-jdk





